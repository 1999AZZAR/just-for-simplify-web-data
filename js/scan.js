var duts,elxtime,nameJson=[],scanJson={aps:[],stations:[]};function drawScan(){var s,e,n,a;getE("apNum").innerHTML=scanJson.aps.length,s="<tr><th class='id'></th><th class='ssid'>SSID</th><th class='name'>Name</th><th class='ch'>Ch</th><th class='rssi'>RSSI</th><th class='enc'>Enc</th><th class='lock'></th><th class='mac'>MAC</th><th class='vendor'>Vendor</th><th class='selectColumn'></th><th class='remove'></th></tr>";for(var t=0;t<scanJson.aps.length;t++)e=scanJson.aps[t][scanJson.aps[t].length-1],a=(n=parseInt(scanJson.aps[t][3])+130)<50?"meter_red":n<70?"meter_orange":"meter_green",s+=(e?"<tr class='selected'>":"<tr>")+"<td class='id'>"+t+"</td><td class='ssid'>"+esc(scanJson.aps[t][0])+"</td><td class='name'>"+(scanJson.aps[t][1].length>0?esc(scanJson.aps[t][1]):"<button onclick='add(0,"+t+")'>"+lang("add")+"</button>")+"</td><td class='ch'>"+esc(scanJson.aps[t][2])+"</td><td class='rssi'><div class='meter_background'> <div class='meter_forground "+a+"' style='width: "+n+"%;'><div class='meter_value'>"+scanJson.aps[t][3]+"</div></div> </div></td><td class='enc'>"+esc(scanJson.aps[t][4])+"</td><td class='lock'>"+("-"==scanJson.aps[t][4]?"":"&#x1f512;")+"</td><td class='mac'>"+esc(scanJson.aps[t][5])+"</td><td class='vendor'>"+esc(scanJson.aps[t][6])+"</td><td class='selectColumn'><label class='checkBoxContainer'><input type='checkbox' "+(e?"checked":"")+" onclick='selectRow(0,"+t+","+(e?"false":"true")+")'><span class='checkmark'></span></label></td><td class='remove'><button class='red' onclick='remove(0,"+t+")'>X</button></td></tr>";getE("apTable").innerHTML=s,getE("stNum").innerHTML=scanJson.stations.length,s="<tr><th class='id'></th><th class='vendor'>Vendor</th><th class='mac'>MAC</th><th class='ch'>Ch</th><th class='name'>Name</th><th class='pkts'>Pkts</th><th class='ap'>AP</th><th class='lastseen'>Last seen</th><th class='selectColumn'></th><th class='remove'></th></tr>";for(t=0;t<scanJson.stations.length;t++)e=scanJson.stations[t][scanJson.stations[t].length-1],ap="",scanJson.stations[t][5]>=0&&(ap=esc(scanJson.aps[scanJson.stations[t][5]][0])),s+=(e?"<tr class='selected'>":"<tr>")+"<td class='id'>"+t+"</td><td class='vendor'>"+esc(scanJson.stations[t][3])+"</td><td class='mac'>"+esc(scanJson.stations[t][0])+"</td><td class='ch'>"+esc(scanJson.stations[t][1])+"</td><td class='name'>"+(scanJson.stations[t][2].length>0?esc(scanJson.stations[t][2]):"<button onclick='add(1,"+t+")'>"+lang("add")+"</button>")+"</td><td class='pkts'>"+esc(scanJson.stations[t][4])+"</td><td class='ap'>"+ap+"</td><td class='lastseen'>"+esc(scanJson.stations[t][6])+"</td><td class='selectColumn'><label class='checkBoxContainer'><input type='checkbox' "+(e?"checked":"")+" onclick='selectRow(1,"+t+","+(e?"false":"true")+")'><span class='checkmark'></span></label></td><td class='remove'><button class='red' onclick='remove(1,"+t+")'>X</button></td></tr>";getE("stTable").innerHTML=s}function drawNames(){var s,e;getE("nNum").innerHTML=nameJson.length,s="<tr><th class='id'></th><th class='mac'>MAC</th><th class='vendor'>Vendor</th><th class='name'>Name</th><th class='ap'>AP-BSSID</th><th class='ch'>Ch</th><th class='save'></th><th class='selectColumn'></th><th class='remove'></th></tr>";for(var n=0;n<nameJson.length;n++)s+=((e=nameJson[n][nameJson[n].length-1])?"<tr class='selected'>":"<tr>")+"<td class='id'>"+n+"</td><td class='mac' contentEditable='true' id='name_"+n+"_mac'>"+esc(nameJson[n][0])+"</td><td class='vendor'>"+esc(nameJson[n][1])+"</td><td class='name' contentEditable='true' id='name_"+n+"_name'>"+esc(nameJson[n][2].substring(0,16))+"</td><td class='ap' contentEditable='true' id='name_"+n+"_apbssid'>"+esc(nameJson[n][3])+"</td><td class='ch' contentEditable='true' id='name_"+n+"_ch'>"+esc(nameJson[n][4])+"</td><td class='save'><button class='green' onclick='save("+n+")'>"+lang("save")+"</button></td><td class='selectColumn'><label class='checkBoxContainer'><input type='checkbox' "+(e?"checked":"")+" onclick='selectRow(2,"+n+","+(e?"false":"true")+")'><span class='checkmark'></span></label></td><td class='remove'><button class='red' onclick='remove(2,"+n+")'>X</button></td></tr>";getE("nTable").innerHTML=s}function scan(s){switch(getE("RButton").disabled=!0,s){case 0:getE("scanOne").disabled=!0,getE("scanZero").style.visibility="hidden",elxtime=2450;break;case 1:getE("scanZero").disabled=!0,getE("scanOne").style.visibility="hidden",elxtime=parseInt(getE("scanTime").value+"000")+1500}var e="scan "+(0==s?"aps ":"stations -t "+getE("scanTime").value+"s")+" -ch "+getE("ch").options[getE("ch").selectedIndex].value;getFile("run?cmd="+e),duts=parseInt(s),setTimeout(buttonFunc,elxtime),setTimeout(load,elxtime)}function buttonFunc(){switch(duts){case 0:getE("scanZero").style.visibility="visible",getE("scanOne").disabled=!1;break;case 1:getE("scanOne").style.visibility="visible",getE("scanZero").disabled=!1}getE("RButton").disabled=!1}function load(){getFile("run?cmd=save scan",(function(){getFile("scan.json",(function(s){scanJson=JSON.parse(s),showMessage("connected"),drawScan()}))})),getFile("run?cmd=save names",(function(){getFile("names.json",(function(s){nameJson=JSON.parse(s),showMessage("connected"),drawNames()}))}))}function selectRow(s,e,n){switch(s){case 0:scanJson.aps[e][7]=n,drawScan(),getFile("run?cmd="+(n?"":"de")+"select ap "+e);break;case 1:scanJson.stations[e][7]=n,drawScan(),getFile("run?cmd="+(n?"":"de")+"select station "+e);break;case 2:save(e),nameJson[e][5]=n,drawNames(),getFile("run?cmd="+(n?"":"de")+"select name "+e)}}function remove(s,e){switch(s){case 0:scanJson.aps.splice(e,1),drawScan(),getFile("run?cmd=remove ap "+e);break;case 1:scanJson.stations.splice(e,1),drawScan(),getFile("run?cmd=remove station "+e);break;case 2:nameJson.splice(e,1),drawNames(),getFile("run?cmd=remove name "+e)}}function save(s){var e=getE("name_"+s+"_mac").innerHTML.replace("<br>",""),n=getE("name_"+s+"_name").innerHTML.replace("<br>",""),a=getE("name_"+s+"_apbssid").innerHTML.replace("<br>",""),t=getE("name_"+s+"_ch").innerHTML.replace("<br>","");if(e!=nameJson[s][0]||n!=nameJson[s][2]||a!=nameJson[s][3]||t!=nameJson[s][4]){if(nameJson[s][0]=e,nameJson[s][2]=n,nameJson[s][3]=a,nameJson[s][4]=t,17!=nameJson[s][0].length)return void showMessage("ERROR: MAC invalid");getFile("run?cmd=replace name "+s+' -n "'+nameJson[s][2]+'" -m "'+nameJson[s][0]+'" -ch '+nameJson[s][4]+' -b "'+nameJson[s][3]+'" '+(nameJson[s][5]?"-s":"")),drawNames()}}function add(s,e){if(nameJson.length>=25)showMessage("Device Name List is full!");else{switch(s){case 0:getFile('run?cmd=add name "'+scanJson.aps[e][0]+'" -ap '+e),scanJson.aps[e][1]=scanJson.aps[e][0],nameJson.push([scanJson.aps[e][5],scanJson.aps[e][6],scanJson.aps[e][0],"",scanJson.aps[e][2],!1]),drawScan();break;case 1:getFile('run?cmd=add name "'+scanJson.stations[e][0]+'" station '+e),scanJson.stations[e][2]="device_"+nameJson.length,nameJson.push([scanJson.stations[e][0],scanJson.stations[e][3],"device_"+nameJson.length,scanJson.aps[scanJson.stations[e][5]][5],scanJson.stations[e][1],!1]),drawScan();break;case 2:getFile("run?cmd=add name device_"+nameJson.length+" -m 00:00:00:00:00:00 -ch 1"),nameJson.push(["00:00:00:00:00:00","","device_"+nameJson.length,"",1,!1]),drawNames()}drawNames()}}function selectAll(s,e){switch(s){case 0:getFile("run?cmd="+(e?"":"de")+"select aps");for(var n=0;n<scanJson.aps.length;n++)scanJson.aps[n][7]=e;drawScan();break;case 1:getFile("run?cmd="+(e?"":"de")+"select stations");for(n=0;n<scanJson.stations.length;n++)scanJson.stations[n][7]=e;drawScan();break;case 2:getFile("run?cmd="+(e?"":"de")+"select names");for(n=0;n<nameJson.length;n++)nameJson[n][5]=e;drawNames()}}
